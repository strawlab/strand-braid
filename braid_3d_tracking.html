<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Braid: 3D Tracking - User's Guide for Braid and Strand Camera</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Low latency image processing and tracking">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="braid-and-strand-camera.html">Braid and Strand Camera</a></li><li class="chapter-item expanded "><a href="hardware-selection.html"><strong aria-hidden="true">1.</strong> Hardware selection</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="braid_configuration_and_launching.html"><strong aria-hidden="true">3.</strong> Configuring and Launching Braid</a></li><li class="chapter-item expanded "><a href="braidz-files.html"><strong aria-hidden="true">4.</strong> BRAIDZ files and Analysis Scripts</a></li><li class="chapter-item expanded "><a href="braid_3d_tracking.html" class="active"><strong aria-hidden="true">5.</strong> Braid: 3D Tracking</a></li><li class="chapter-item expanded "><a href="parameters_for_object_detection_and_tracking.html"><strong aria-hidden="true">6.</strong> Parameters for Object Detection and Tracking</a></li><li class="chapter-item expanded "><a href="braid_calibration.html"><strong aria-hidden="true">7.</strong> Braid: 3D Calibration</a></li><li class="chapter-item expanded "><a href="braid_remote_cameras.html"><strong aria-hidden="true">8.</strong> Braid: Remote cameras</a></li><li class="chapter-item expanded "><a href="scripting-with-python.html"><strong aria-hidden="true">9.</strong> Scripting with Python</a></li><li class="chapter-item expanded "><a href="processing-saved-videos.html"><strong aria-hidden="true">10.</strong> Processing saved videos</a></li><li class="chapter-item expanded "><a href="fmf_format.html"><strong aria-hidden="true">11.</strong> Fly Movie Format</a></li><li class="chapter-item expanded "><a href="troubleshooting.html"><strong aria-hidden="true">12.</strong> Troubleshooting</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">User's Guide for Braid and Strand Camera</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/strawlab/strand-braid/tree/main/strand-braid-user/users-guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#3d-tracking-in-braid" id="3d-tracking-in-braid">3D Tracking in Braid</a></h1>
<h2><a class="header" href="#principle-of-operation" id="principle-of-operation">Principle of operation</a></h2>
<p>This page describes the basic principles of how tracking in 3D is implemented by
Braid. A more detailed and more mathematical description can be found in the
paper describing Braid's predecessor, Straw et al. (2011). Please refer to this
for more details.</p>
<p>Straw et al. 2011: Straw AD, Branson K, Neumann TR, Dickinson MH (2011) Multicamera
Realtime 3D Tracking of Multiple Flying Animals. <em>Journal of The Royal Society
Interface 8</em>(11), 395-409.
<a href="http://dx.doi.org/10.1098/rsif.2010.0230">doi:10.1098/rsif.2010.0230</a></p>
<p><img src="images/rsif20100230f02.jpg" alt="images/rsif20100230f02.jpg" />.</p>
<p><strong>Figure 1: Principles of 3D Tracking in Braid.</strong> References in blue refer to
parts of <a href="http://dx.doi.org/10.1098/rsif.2010.0230">Straw et al. (2011)</a>. (a)
Flowchart of operations. (b) Schematic of a two-dimensional camera view showing
the raw images (brown), feature extraction (blue), state estimation (black), and
data association (red). (c) Three-dimensional reconstruction using the EKF uses
prior state estimates (open circle) and observations (blue lines) to construct a
posterior state estimate (filled circle) and covariance ellipsoid (dotted
ellipse). This figure and some caption text reproduced from Figure 2 of <a href="http://dx.doi.org/10.1098/rsif.2010.0230">Straw
et al. (2011)</a> under the Creative
Commons Attribution License.</p>
<p>(TODO: walkthrough of figure above.)</p>
<h2><a class="header" href="#tracking-in-water-with-cameras-out-of-water" id="tracking-in-water-with-cameras-out-of-water">Tracking in water with cameras out of water</a></h2>
<p>One important aspect of Braid not covered in <a href="http://dx.doi.org/10.1098/rsif.2010.0230">Straw et al.
(2011)</a> is the the capability of
tracking fish (or other objects in water) from cameras placed above the water
surface.</p>
<h3><a class="header" href="#refraction" id="refraction">Refraction</a></h3>
<p>When looking through the air-water interface (or any refractive boundary),
objects on the other side appear from a different direction than the direct path
to the object due to <a href="https://en.wikipedia.org/wiki/Refraction">refraction</a>.
Mathematically, refraction is described by <a href="https://en.wikipedia.org/wiki/Fermat%27s_principle">Fermat's principle of least
time</a>, and this forms the
basis of Braid's tracking in water.</p>
<h3><a class="header" href="#principle-of-operation-for-tracking-in-water" id="principle-of-operation-for-tracking-in-water">Principle of operation for tracking in water</a></h3>
<p>When considering the principle of operation of 3D tracking described above, the
primary addition to Braid required for tracking in water is the ability to model
the rays coming from the animal to the camera not as straight lines but rather
having a bend due to refraction. To implement this, the observation model of the
extended Kalman filter is extended to incorporate the air-water boundary so that
it consists of both a 3D camera model and air-water surface model. Thus, during
the update step of the Kalman filter, this non-linear model is linearized about
the expected (<em>a priori</em>) position of the tracked object.</p>
<p>Currently, Braid has a simplification that the model of the air-water boundary
is always fixed at z=0. Thus, anything with z&lt;0 is under water and anything with
z&gt;0 is above water. This implies that the coordinate frame for tracking with an
air-water boundary must have this boundary at z=0 for correct tracking.</p>
<h3><a class="header" href="#how-to-enable-tracking-in-water" id="how-to-enable-tracking-in-water">How to enable tracking in water.</a></h3>
<p>Practically speaking, tracking using the model of an air-water boundary is
enabled by placing the string <code>&lt;water&gt;1.333&lt;/water&gt;</code> the XML camera calibration
file. This will automatically utilize the refractive boundary model described
above with a value for the refractive index of 1.333 for the medium at z&lt;0. As
1.333 is the refractive index of water, it is a model of refraction in water.</p>
<h2><a class="header" href="#tracking-multiple-objects-in-3d" id="tracking-multiple-objects-in-3d">Tracking multiple objects in 3D</a></h2>
<p>It is possible to use Braid to track two or more objects in 3D. Typically this
requires the per-camera, 2D object detection to be set to also detect multiple
objects. Thus, the parameter <code>max_num_points</code> in the Object Detection
configuration of Strand Camera should be set to at least the number of objects
that should be tracked.</p>
<p>To maintain object identity over time, such that a single trajectory is recorded
for a single animal, Braid uses a simple data association algorithm which
assumes independent movement of the tracked objects. This is sufficient in many
cases for tracking animals even when they interact strongly with each other, but
it is typically be necessary to tune relevant tracking and data association
parameters to get the best performance possible.</p>
<h2><a class="header" href="#details-about-how-data-are-processed-online-and-saved-for-later-analysis" id="details-about-how-data-are-processed-online-and-saved-for-later-analysis">Details about how data are processed online and saved for later analysis</a></h2>
<p>While running, Braid saves a copy of all incoming feature detections from the
cameras as a first step prior to inspecting frame numbers and bundling data from
synchronously acquired data from multiple cameras. Combined with issues such as
unreliable networks, this has the unfortunate effect that frames saved to disk
cannot be guaranteed to be monotonically increasing. For online processing to
implement 3D tracking, there is always an idea of &quot;current frame number&quot;. Any
data from prior frames is immediately discarded from further consideration (but
it was saved to disk as described above). If the incoming frame number is larger
than the current frame number, any accumulated data for the &quot;current frame&quot; is
deemed complete and this is bundled for immediate processing. If the incoming
frame number is larger than a single frame from the current frame number,
additional frames of empty data are generated so that the stream of bundled data
is contiguous (with no gaps) up until the incoming frame number, which then
becomes the new &quot;current frame number&quot;.</p>
<p>Note that in post-processing based on data saved in <code>.braidz</code> files, a better
reconstruction can be made than possible in the online approach described above
because data which may have been discarded originally could be incorporated into
the tracking process. Furthermore, because latency is no longer a significant
concern, reconstruction for a particular instant need not be performed with only
historical data but can also incorporate information that occurred after that
instant.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="braidz-files.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="parameters_for_object_detection_and_tracking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="braidz-files.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="parameters_for_object_detection_and_tracking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
